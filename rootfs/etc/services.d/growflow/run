#!/usr/bin/with-contenv bashio
# ==============================================================================
# Home Assistant Community Add-on: GrowFlow Plant Tracker
# Runs the GrowFlow Plant Tracker service
# ==============================================================================

# Wait for data directory
while ! bashio::fs.directory_exists "/data"; do
    sleep 1
done

# Get configuration from Home Assistant
export MQTT_BROKER=$(bashio::config 'mqtt_broker')
export MQTT_PORT=$(bashio::config 'mqtt_port')
export MQTT_USERNAME=$(bashio::config 'mqtt_username')
export MQTT_PASSWORD=$(bashio::config 'mqtt_password')
export HA_URL=$(bashio::config 'ha_url')
export HA_TOKEN=$(bashio::services 'http' 'supervisor_token')
export LOG_LEVEL=$(bashio::config 'log_level')
export BACKUP_ENABLED=$(bashio::config 'backup_enabled')
export BACKUP_INTERVAL_HOURS=$(bashio::config 'backup_interval_hours')

# Set database path
export DB_PATH=/data/growflow.db

# Set production environment
export NODE_ENV=production

bashio::log.info "Starting GrowFlow Plant Tracker..."
bashio::log.info "MQTT Broker: ${MQTT_BROKER}:${MQTT_PORT}"
bashio::log.info "Home Assistant URL: ${HA_URL}"
bashio::log.info "Database path: ${DB_PATH}"

cd /app || bashio::exit.nok "Could not change directory to /app"

# Start the application
exec npm start